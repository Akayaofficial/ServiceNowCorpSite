name: ServiceNow DevOps Workflow

on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "main"
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Build
        run: |
          # Add your build commands here
          echo '<?xml version="1.0" encoding="UTF-8"?>
          <testsuites name="Test run" tests="8" failures="1" errors="1" skipped="1" 
              assertions="20" time="16.082687" timestamp="2021-04-02T15:48:23">
              <!-- Your dummy data goes here -->
          </testsuites>' > sample-test-results.xml

  test:
    name: 'Test'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Display Test XML Content
        run: cat sample-test-results.xml

      - name: Convert XML to JSON
        run: |
          npm install -g xml-js
          xml2json < sample-test-results.xml > sample-test-results.json

      - name: Submit Test Results to ServiceNow
        run: |
          curl -X POST \
            -u "${{ secrets.SN_DEVOPS_USER }}:${{ secrets.SN_DEVOPS_PASSWORD }}" \
            -H "Content-Type: application/json" \
            -d @sample-test-results.json \
            "${{ secrets.SN_INSTANCE_URL }}/api/now/table/sn_devops_test_summary"
          
